# XSS(Cross Site Scripting)防御手册

## 1 引言

本文提供了一个简单的正向机制来阻止 [XSS](https://www.owasp.org/index.php/Cross-site_Scripting_(XSS))：恰当地输出转义/编码后数据。虽然有大量的 XSS 攻击方式，但是遵循一些简单的规则可以完全抵御这些严重攻击。
本文不探讨 XSS 的对技术、业务的影响，只说 XSS 可以导致攻击者能够具有操作浏览器的能力。

[反射型和存储型 XSS](https://www.owasp.org/index.php/Cross-site_Scripting_(XSS)#Stored_and_Reflected_XSS_Attacks)都可以通过在服务端执行适当的验证和转义来规避。[基于DOM的XSS](https://www.owasp.org/index.php/DOM_Based_XSS) 可以使用 [基于DOM的XSS预防手册](https://www.owasp.org/index.php/DOM_based_XSS_Prevention_Cheat_Sheet) 一文中描述的子集规则来避免。

有关XSS相关的攻击方法，请参阅[XSS过滤规避手册](https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet)。在[浏览器安全手册](https://code.google.com/archive/p/browsersec/)可以找到关于浏览器安全和各种浏览器的更多背景。

在阅读本文之前，需要对[注入理论](https://www.owasp.org/index.php/Injection_Theory)有个基本了解。

### 1.1 积极的XSS防御模型

本文将HTML页面视为模板，并允许开发人员在插槽(slots)中插入不可信数据。这些插槽覆盖了绝大多数开发人员放置不可信数据的位置。不允许在在 HTML 的其他位置放置不可信数据。这是一个白名单模式，只有在白名单之中的才是被允许的。

鉴于浏览器解析HTML的方式，不同类型的插槽具有稍微不同的安全规则。将不可信数据放入到插槽时，需要采取一定的措施来确保数据不会从该插槽中跳到允许执行代码的上下文中。从某种意义上，这种方法将HTML文档视为参数化的数据库查询——数据保存在特定的位置，并通过转义与代码上下文隔离。

本文列出了安全地将不可信数据放入常见的插槽的规则。基于大量的规则、已知的XSS攻击方法和大量的先进浏览器的测试，我们可以保证我们提出的规则是安全的。

我们定义了插槽位置并对每个插槽提供了几个例子。为了确保安全，开发人员不应该在没有仔细分析的情况下就将不可信数据放入到其它插槽位置。浏览器解析是非常棘手的，许多看起来无害的角色可能在特定的上下文中起非常重要的作用。

### 1.2 为什么不能对不可信数据只进行 HTML 实体编码？

HTML实体编码对于用来编码放置在HTML标签中的不可信数据是可以的，例如\<div>标记内。对于使用引号包裹的属性，使用HTML实体编码对于不可信数据来说也是可行的。但是，如果你将不可信的数据放置到<script>标记的任何位置、onmouseover事件处理程序、CSS内部或者URL中，那么HTML实体编码就不起作用了,这时即便你到处使用HTML实体编码仍然可能遭受XSS攻击。你必须对特定HTML文档部分放置的不可信数据，使用编码语法进行处理。这也是我们下面所要讲的。
  
 ### 1.3 你需要一个安全的编码库
  
编写这些编码器并不是非常困难，但是也有不少隐藏的陷阱。例如，你可能会在 JavaScript 中试图使用像 \" 这样的快捷转义。但是,这样做是危险的，可能会被浏览器中的嵌套解析器误解。你也可能忘记转义转义字符，攻击者可以中和掉你的转义。OWASP建议使用一个专注安全的编码库，以确保这些规则正确实施。

Microsoft为.NET平台提供了一个名为[Microsoft Anti-Cross Site Scripting Library](http://wpl.codeplex.com/)的编码库，并且ASP.NET Framework内置了[ValidateRequest](https://msdn.microsoft.com/en-us/library/ms972969.aspx#securitybarriers_topic6)函数，可以进行一定的清洗。

 OWASP的[OWASP Java Encoder Project](https://www.owasp.org/index.php/OWASP_Java_Encoder_Project)为Java提供了高性能的编码库。

## 2 XSS防御规则
 
以下规则旨在防止应用程序中所有XSS。尽管这些规则不允许绝对自由地将不可信数据放入HTML文档，但它们应该能覆盖绝大多数常见用例。在你的代码中可能不必开启所有的规则。许多组织可能会发现只运行规则1和规则2就足够满足他们的需求。如果额外的有些上下文是经常需要的，并且可以通过转义进行保护，请在讨论页面上添加讨论。

不要简单地转义在各种规则中提供的示例字符。仅仅转义这个列表是不够的，黑名单方法相当脆弱。这里的白名单规则经过精心设计，即使针对由浏览器更改引入的未来漏洞，也能提供保护。

### 2.1 规则0，除了在允许的位置，绝不能在其他位置插入不可信任的数据

首要规则是拒绝全量——不要把不可信数据完整放到你的HTML文档中，除非是放到规则1或者规则5定义的插槽中。规则0的原因是，HTML中有很多奇怪的上下文，转义规则列表变的非常的复杂。在这种复杂的情况下，我们找不到一个理由在这些上下文中放置放置不可信数据。这包含了像在 JavaScript 中的 URL 这种嵌套上下文，这些位置的编码规则是相当棘手与危险的。如果你坚持把不可信的数据放到嵌套的上下文中，请做大量的跨浏览器测试，并让我们知道你发现了什么。

```
 <script>...永远不要在这里放置不可信数据...</script>     直接在Script中
 <!--...永远不要在这里放置不可信数据...-->               在HTML注释中
 <div ...永远不要在这里放置不可信数据...=test />         属性名称
 <永远不要在这里放置不可信数据... href="/test" />        标签名称
 <style>...永远不要在这里放置不可信数据...</style>       直接在CSS中
```

最重要的是永远不要接受来自不可信来源的JavaScript代码然后运行它。例如，一个名为"callback"的参数包含JavaScript代码片段，再多的转义也不能解决这个问题。

### 2.2 规则1，将不可信数据插入到 HTML 元素内容之前，进行 HTML 转义

规则1适用于将不可信数据放到HTML标签内的地方，例如 div、p、b、td等常见标签。大多数的Web框架都有一个HTML转义的方法，来转义下面将要说到的字符，但是这种转义对于其他HTML上下文是绝对不够的，仍然需要执行其它规则。

```
 <body>...在插入这里之前转义不可信数据...</body>
 <div>...在插入这里之前转义不可信数据...</div>
 其他正常的 HTML 标签
```

使用HTML实体编码转义下列字符，以防止切换到任何执行上下文，如脚本、样式或事件处理程序中。在规范中推荐使用十六进制实体，除了XML（＆，<，>，",'）中的5个重要字符之外，还包括正斜杠，因为它可以结束HTML实体。

 ```
 & --> &amp;
 < --> &lt;
 > --> &gt;
 " --> &quot;
 ' --> &#x27;     &apos; 不推荐，因为它不在HTML规范中, &apos;存在于在XML和XHTML规范中。
 / --> &#x2F;     包括正斜杠，因为它有可以结束一个HTML实体
 ```
 
### 2.3 规则2，将不可信数据插入到HTML通用属性之前，进行HTML Attribute转义

规则2是将不可信数据放入典型的属性值里，如 width, name和value 等。这个规则不应该用于复杂属性：href、src、style，或者诸如onmouseover等事件处理程序。 作为HTML JavaScript数据，事件处理程序这类属性应该遵循规则3，这一点是非常重要的。

```
 <div attr=...在插入这里之前转义不可信数据...>内容</div>      属性值无引号包裹 
 <div attr='...在插入这里之前转义不可信数据...'>内容</div>    属性值使用单引号包裹
 <div attr="...在插入这里之前转义不可信数据...">内容</div>    属性值使用双引号包裹
```

除了字母数字字符以外，使用 &#xHH;(或者可用的命名实体)格式来转义ASCII值小于256所有的字符，来防止切换出属性上下文。这个规则覆盖这么多字符的原因是开发者写属性时经常不把属性放到引号之中。相应的引号包裹的属性只能用相应的引号转义规则。没有引号的属性可能使用好多字符来分开：包括 [ 空格 ] %  * + , - / ; < = > ^ 和 |。

 ### 2.4 规则3，将不可信数据插入到JavaScript数据值之前，进行JavaScript转义
 
 规则3涉及动态生成的 JavaScript 代码——script 块和事件处理程序属性中。将不可信数据放入此类代码断的唯一安全位置：引号包裹的数值位置。在其他任何 JavaScript 上下文中包含不可信数据都是相当危险的，因为包含但是不限于分号、等号、空格、加号等字符来切换到一个执行上下文是非常容易的，所以请谨慎使用。

```
 <script>alert('...在插入这里之前转义不可信数据...')</script>                 写在引号包裹的字符串中
 <script>x='...在插入这里之前转义不可信数据...'</script>                      写在表达式中的引号中
 <div onmouseover="x='...在插入这里之前转义不可信数据...'"</div>              写在引号包裹的事件处理程序中
```
 

